<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>c++ kd-tree implementations | talldoor</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="c++ kd-tree implementations" />
<meta name="author" content="Yu Cong" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="勉强坚持一下月更…" />
<meta property="og:description" content="勉强坚持一下月更…" />
<link rel="canonical" href="https://talldoor.uk/alg/cpp/2023/04/01/research_on_kdtree.html" />
<meta property="og:url" content="https://talldoor.uk/alg/cpp/2023/04/01/research_on_kdtree.html" />
<meta property="og:site_name" content="talldoor" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-04-01T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="c++ kd-tree implementations" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://talldoor.uk/alg/cpp/2023/04/01/research_on_kdtree.html"},"url":"https://talldoor.uk/alg/cpp/2023/04/01/research_on_kdtree.html","author":{"@type":"Person","name":"Yu Cong"},"headline":"c++ kd-tree implementations","dateModified":"2023-04-01T00:00:00+08:00","description":"勉强坚持一下月更…","datePublished":"2023-04-01T00:00:00+08:00","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?">
  <link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://talldoor.uk/feed.xml" title="talldoor" /><!-- Add CSS for syntax highlighting -->
  <link rel="stylesheet" href="/assets/stylesheets/pygments.css">
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/"><img src="/favicon.ico" alt="talldoor"></a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/_pages/cat.html">categories</a><a class="page-link" href="/_pages/pdfs.html">slides&amp;notes</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">c++ kd-tree implementations</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2023-04-01T00:00:00+08:00" itemprop="datePublished">Apr 1, 2023
      </time></p>

    <!-- <script
      type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "all" } } }); </script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['$','$'] ],
            processEscapes: true
          }
        });
      </script>
    <script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> -->
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>勉强坚持一下月更…</p>
<p>操作系统作业要写一下死锁检测
https://en.wikipedia.org/wiki/Banker’s_algorithm
里面有一步大概是在所有进程的 required_resources 对应的向量里面找小于系统
available_resources 对应的向量, 更新 available_resources 再找,
重复这样的过程.
实际上就是在一些<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.04ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 878.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
<defs>
<path stroke-width="1" id="E1-MJMATHI-6D" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)">
 <use xlink:href="#E1-MJMATHI-6D" x="0" y="0"></use>
</g>
</svg>维的点里面不断询问给定的一个 axis parallel box 当中的点是哪些.
想用kd-tree让这个过程跑的更快一些, 于是开始找c++的kd-tree实现.</p>
<p>理想的 implementation 应该是这样的: 点的类型是一个模板参数,
kd-tree只要求这个点的类型重载了&lt;=和[],
分别用来定义点的严格大小关系和取出第k维的值,
另外每个维度的值也应该重载&lt;=, 应该真的支持k维的点,
期望复杂度能做到和理论一致 https://en.wikipedia.org/wiki/K-d_tree,
支持删除插入…</p>
<p>大概找了三个实现:</p>
<ul>
<li>kdtree-cpp: https://github.com/cdalitz/kdtree-cpp</li>
<li>ikd-Tree: https://github.com/hku-mars/ikd-Tree</li>
<li>nanoflann: https://github.com/jlblancoc/nanoflann</li>
</ul>
<h3 id="kdtree-cpp">kdtree-cpp</h3>
<p>这是个不错的实现, 作者写的代码比较简洁,
并且knn支持多种距离度量(继承<code>DistanceMeasure</code>类之后稍微修改就行了,
不过死锁检测也用不到knn), 但是点的类型是
<code>vector&lt;vector&lt;double&gt;&gt;</code> 维度都需要运行时判断,
而且只有knn方面的函数, 另外还有<code>std::nth_element</code>的问题,
在ikd-Tree当中一起讨论. 不支持插入删除. 我觉得写的很好,
但是需要补充和调整很多东西才能用到别的地方去.</p>
<h3 id="ikd-tree">ikd-Tree</h3>
<p>这个实现是在arxiv上一篇文章中用到的:
https://arxiv.org/abs/2102.10808</p>
<p>看文章和测试的结果, 速度非常快, 支持插入删除,
而且直接提供了<code>Box_Search</code>这样的函数.</p>
<p>严重的问题是文章绝大部分和github的README当中都在说kd-tree,
而且代码当中 PointType 也是一个模板参数, 但是只支持三维…
花了不少时间看文章和文档都没有发现…</p>
<p>更加严重的问题是<code>std::nth_element</code>,
https://github.com/hku-mars/ikd-Tree/issues/25
在查询一个范围中的点时不能根据kdtree当中一个节点划分的维度对应的值来判断是应该向左子树还是右子树搜索.
issue当中已经给了一个例子.</p>
<h3 id="nanoflann">nanoflann</h3>
<p>我没仔细看, 根据 examples
他是支持任意维度的点插入删除的…看起来满足所有的要求.</p>
<p>在ikd-Tree的issue当中看到建树的时候直接用了</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>    DistanceType split_val <span class="op">=</span> <span class="op">(</span>bbox<span class="op">[</span>cutfeat<span class="op">].</span>low <span class="op">+</span> bbox<span class="op">[</span>cutfeat<span class="op">].</span>high<span class="op">)</span> <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span></code></pre></div>
<p>貌似不能保证树是平衡的?</p>
<p>在看和改这些kd-tree上花费的时间感觉足够从头开始写一个了,
最终也没有用前面两个实现改出一个我能用上的kd-tree…</p>

  </div><a class="u-url" href="/alg/cpp/2023/04/01/research_on_kdtree.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">talldoor</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Yu Cong</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/congyu711"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">congyu</span></a></li><li><a href="/feed.xml"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#rss"></use></svg> <span>feed.xml</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p><a href="https://steamcommunity.com/profiles/76561198450041000/"><img src="/assets/image/Wooden_Door.png" alt="talldoor"></a></p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
